{%- liquid
  unless settings.cart_action == 'no-overlay' or template.name contains 'cart'
    assign show_cart = true
  elsif request.design_mode
    assign show_cart = true
  else
    assign show_cart = false
  endunless
-%}

{%- if show_cart -%}
  <sidebar-drawer
    id="site-cart-sidebar"
    data-direction="right"
    class="sidebar {% if cart.item_count == 0 %} cart-is-empty {% endif %}"
    tabindex="-1"
    role="dialog"
    aria-modal="true"
    data-cart-items="{{ cart.item_count }}"
    style="display:none"
    data-js-site-cart-sidebar
  >
    <div class="sidebar__container">
      <div class="sidebar__content">
        <div class="sidebar__header">
          <span class="sidebar__title text-size--18 text-weight--bold text-transform--uppercase">
            {{ 'cart.title' | t }}
            (<span data-header-cart-count>{{ cart.item_count }}</span>)
          </span>
          <button class="sidebar__close" data-js-close>
            <span class="visually-hidden">{{ 'general.accessibility_labels.close_sidebar' | t }}</span>
            <span aria-hidden="true" aria-role="img">{%- render 'theme-symbols', icon: 'close-small' -%}</span>
          </button>
        </div>

        <div class="sidebar__body sidebar__body--flex">
          <div class="sidebar__body-top">
            <div class="cart-form">
              {%- render 'cart-form', type: 'sidebar' -%}
              <div class="cart-continue">
                {%- render 'button',
                  label: 'cart.continue_shopping',
                  label_is_translation: true,
                  style: 'outline-arrow',
                  type: 'button',
                  attribute: 'data-js-close',
                  class: ' button--small'
                -%}
              </div>
            </div>

            {%- unless section.settings.cart_upsell_product == blank -%}
              <div class="hide-if-empty-cart">
                <span class="gutter--sidebar border--sidebar" style="display:block;margin-top:5px">
                  {{- section.settings.cart_upsell_heading | escape -}}
                </span>
                {%- render 'product-cross-sell',
                  product: section.settings.cart_upsell_product,
                  id: 'cart-individual-product-cross-sell',
                  class: 'cart-individual-product-recommendation',
                  type: 'sidebar'
                %}
              </div>
            {%- endunless -%}
          </div>

          {%- if settings.show_discount_code or settings.cart_notes_enable -%}
            <div class="sidebar__body-bottom hide-if-empty-cart">
              {%- if settings.cart_notes_enable -%}
                <div
                  class="cart__instructions cart-detail--collapsible-{{ settings.show_collapsible_notes_discount }} gutter--sidebar"
                  {% if settings.show_collapsible_notes_discount == false %}
                    style="margin-top:6px;padding-bottom:18px"
                  {% endif %}
                >
                  {%- if settings.show_collapsible_notes_discount -%}
                    <details class="cart__accordion-details">
                      <summary class="align-content align-content--vertical-middle">
                        <span class="cart__accordion-title cart__note-title">
                          {{ 'cart.note' | t }}
                        </span>

                        <span class="cart__accordion-icon cart__note-icon" aria-hidden="true">
                          {%- render 'theme-symbols', icon: 'chevron' -%}
                        </span>
                      </summary>
                  {%- endif -%}

                  <div class="form-field">
                    <cart-note>
                      <label
                        for="CartDrawer-Note"
                        class="{% if settings.show_collapsible_notes_discount %}visually-hidden{% endif %}"
                      >
                        {{ 'cart.note' | t }}
                      </label>
                      <textarea id="CartDrawer-Note" name="note">{{ cart.note }}</textarea>
                    </cart-note>
                  </div>

                  {%- if settings.show_collapsible_notes_discount -%}
                    </details>
                  {%- endif -%}
                </div>
              {%- endif -%}

              {%- if settings.show_discount_code -%}
                <div
                  class="cart-detail--collapsible-{{ settings.show_collapsible_notes_discount }} gutter--sidebar"
                  {% if settings.show_collapsible_notes_discount == false %}
                    style="margin-top:6px;padding-bottom:18px"
                  {% endif %}
                >
                  {% liquid
                    assign discount_codes = cart.cart_level_discount_applications | where: 'type', 'discount_code' | map: 'title'
                    for item in cart.items
                      for allocation in item.line_level_discount_allocations
                        if allocation.discount_application.type == 'discount_code'
                          assign discount_codes = item.line_level_discount_allocations | slice: forloop.index0 | map: 'discount_application' | map: 'title' | concat: discount_codes
                        endif
                      endfor
                    endfor

                    assign discount_codes = discount_codes | uniq
                  %}

                  {%- if settings.show_collapsible_notes_discount -%}
                    <details class="cart__accordion-details">
                      <summary class="align-content align-content--vertical-middle">
                        <span class="cart__accordion-title cart__discount-title">
                          {{ 'cart.discount_codes_label' | t }}
                        </span>

                        <span class="cart__accordion-icon cart__discount-icon" aria-hidden="true">
                          {%- render 'theme-symbols', icon: 'chevron' -%}
                        </span>
                      </summary>
                  {%- endif -%}

                  <div class="form-field">
                    <cart-discounts>
                      <label
                        for="CartPage-Discount"
                        class="{%- if settings.show_collapsible_notes_discount -%}visually-hidden{%- endif -%}"
                      >
                        {{ 'cart.discount_codes_label' | t }}
                      </label>

                      <form class="cart__coupons-form">
                        <input id="CartPage-Discount" name="discount" type="text" data-js-discount-input>
                        <button
                          type="submit"
                          id="cartDiscountSubmit"
                          class="button button--small button--outline--hover-accent"
                          data-js-discount-submit
                          style="flex-shrink: 0;"
                        >
                          <span class="button__text">{{ 'collections.apply' | t }}</span>
                        </button>
                      </form>

                      {%- if settings.discount_text != blank -%}
                        <div class="cart__coupons-label text-size--14 text-color--opacity">
                          {{ settings.discount_text | escape }}
                        </div>
                      {%- endif -%}

                      <div class="cart__coupons-error" data-js-discount-error></div>

                      <div class="cart__coupons-codes" data-js-discount-codes>
                        {%- for discount_code in discount_codes -%}
                          {%- render 'cart-item-discount', discount: discount_code, remove: true -%}
                        {%- endfor -%}
                      </div>
                    </cart-discounts>
                  </div>

                  {%- if settings.show_collapsible_notes_discount -%}
                    </details>
                  {%- endif -%}
                </div>
              {%- endif -%}
            </div>
          {%- endif -%}
        </div>

        {%- render 'cart-gift-wrapping', class: 'cart-wrapping--sidebar' -%}

        <div
          class="sidebar__footer hide-if-empty-cart"
          {% if section.settings.sticky_cart_actions %}
            style="position: sticky; bottom: 0; background: var(--color-scheme-background);"
          {% endif %}
          data-drawer-actions="{{ section.settings.cart_drawer_actions }}"
        >
          {%- render 'cart-subtotal', type: 'sidebar' -%}
        </div>
      </div>
    </div>
  </sidebar-drawer>

  <script>
    new MutationObserver((mutations, observer) => {
      if (document.getElementById('cart').classList.contains('cart--empty')) {
        document.getElementById('site-cart-sidebar').classList.add('cart-is-empty');
      } else {
        document.getElementById('site-cart-sidebar').classList.remove('cart-is-empty');
      }
    }).observe(document.querySelector('.cart-form'), {
      attributes: false,
      childList: true,
      subtree: true,
    });
  </script>
{%- endif -%}

{% schema %}
{
  "name": "t:raw-extra-words.drawers.cart.name",
  "class": "mount-drawer",
  "settings": [
    {
      "type": "paragraph",
      "content": "t:raw-extra-words.drawers.cart.info_1"
    },
    {
      "type": "select",
      "id": "cart_drawer_actions",
      "label": "t:raw-extra-words.settings_schema.cart.cart_actions.label",
      "options": [
        {
          "value": "show-view",
          "label": "t:raw-extra-words.settings_schema.cart.cart_actions.option_1"
        },
        {
          "value": "show-checkout",
          "label": "t:raw-extra-words.settings_schema.cart.cart_actions.option_2"
        },
        {
          "value": "show-view show-checkout",
          "label": "t:raw-extra-words.settings_schema.cart.cart_actions.option_3"
        }
      ],
      "default": "show-view show-checkout"
    },
    {
      "type": "checkbox",
      "id": "sticky_cart_actions",
      "label": "t:sticky_cart_actions",
      "default": false
    },
    {
      "type": "header",
      "content": "t:sections.refactor_words.cart_upsell.name"
    },
    {
      "type": "text",
      "id": "cart_upsell_heading",
      "label": "t:sections.product-recommendations.settings.heading.label",
      "default": "Recommended product"
    },
    {
      "type": "product",
      "label": "t:sections.refactor_words.cart_upsell.product",
      "info": "t:sections.refactor_words.cart_upsell.product_info",
      "id": "cart_upsell_product"
    }
  ]
}
{% endschema %}
